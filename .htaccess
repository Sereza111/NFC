# ===================================
# ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ
# ===================================

# Включить кеширование
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Статические файлы (JS, CSS) - 1 год
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  
  # Изображения - 1 год
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  
  # Шрифты - 1 год
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  
  # HTML и манифесты - 1 час
  ExpiresByType text/html "access plus 1 hour"
  ExpiresByType application/xhtml+xml "access plus 1 hour"
  ExpiresByType application/manifest+json "access plus 1 hour"
  
  # JSON данные - не кешировать
  ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# Cache-Control заголовки
<IfModule mod_headers.c>
  # Статические ресурсы - immutable
  <FilesMatch "\.(js|css|jpg|jpeg|png|gif|webp|svg|woff|woff2|ttf|eot|ico)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  
  # HTML - короткий кеш
  <FilesMatch "\.(html|htm)$">
    Header set Cache-Control "public, max-age=3600, must-revalidate"
  </FilesMatch>
  
  # Безопасность
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  
  # CORS для статических ресурсов
  <FilesMatch "\.(svg|woff|woff2|ttf|eot)$">
    Header set Access-Control-Allow-Origin "*"
  </FilesMatch>
</IfModule>

# ===================================
# GZIP СЖАТИЕ
# ===================================
<IfModule mod_deflate.c>
  # Сжимать текстовые файлы
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/atom+xml
  AddOutputFilterByType DEFLATE image/svg+xml
  
  # Не сжимать уже сжатые файлы
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp)$ no-gzip
  
  # Уровень сжатия (1-9, 6 оптимально)
  DeflateCompressionLevel 6
</IfModule>

# ===================================
# BROTLI СЖАТИЕ (если доступен)
# ===================================
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript
  AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json application/xml
  AddOutputFilterByType BROTLI_COMPRESS image/svg+xml
</IfModule>

# ===================================
# ОПТИМИЗАЦИЯ ETAG
# ===================================
<IfModule mod_headers.c>
  # Использовать ETag для валидации кеша
  FileETag MTime Size
</IfModule>

# ===================================
# ПРОКСИ ДЛЯ NODE.JS
# ===================================
<IfModule mod_proxy.c>
  <IfModule mod_proxy_http.c>
    # Проксирование API на Node.js
    ProxyPreserveHost On
    ProxyPass /api http://127.0.0.1:10010/api
    ProxyPassReverse /api http://127.0.0.1:10010/api
  </IfModule>
</IfModule>

# ===================================
# ОТКЛЮЧИТЬ ЛИСТИНГ ДИРЕКТОРИЙ
# ===================================
Options -Indexes

# ===================================
# ЗАЩИТА ОТ HOTLINK
# ===================================
<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # Блокировать hotlink изображений (разрешить свой домен)
  RewriteCond %{HTTP_REFERER} !^$
  RewriteCond %{HTTP_REFERER} !^https?://(www\.)?nfc-vl\.ru [NC]
  RewriteRule \.(jpg|jpeg|png|gif|webp|svg)$ - [F,L]
</IfModule>

# ===================================
# HTTP/2 Server Push (опционально)
# ===================================
<IfModule mod_http2.c>
  # Включить HTTP/2
  Protocols h2 h2c http/1.1
</IfModule>

# ===================================
# ОПТИМИЗАЦИЯ МЕЛКИХ ФАЙЛОВ
# ===================================
<IfModule mod_headers.c>
  # Предзагрузка критических ресурсов
  <FilesMatch "index\.html$">
    Header set Link "</assets/index-*.js>; rel=preload; as=script"
    Header append Link "</assets/index-*.css>; rel=preload; as=style"
  </FilesMatch>
</IfModule>

# ===================================
# ОПТИМИЗАЦИЯ KEEP-ALIVE
# ===================================
<IfModule mod_headers.c>
  Header set Connection "Keep-Alive"
  Header set Keep-Alive "timeout=5, max=100"
</IfModule>

# ===================================
# ОТКЛЮЧИТЬ SERVER SIGNATURE (безопасность)
# ===================================
ServerSignature Off

# ===================================
# MIME TYPES
# ===================================
<IfModule mod_mime.c>
  # JavaScript
  AddType application/javascript js
  AddType text/javascript js
  
  # JSON
  AddType application/json json
  AddType application/manifest+json webmanifest
  
  # Шрифты
  AddType font/woff woff
  AddType font/woff2 woff2
  AddType font/ttf ttf
  AddType font/otf otf
  
  # SVG
  AddType image/svg+xml svg svgz
  AddEncoding gzip svgz
  
  # WebP
  AddType image/webp webp
</IfModule>

# ===================================
# ФАЙЛОВЫЕ ОГРАНИЧЕНИЯ
# ===================================
<IfModule mod_reqtimeout.c>
  # Таймауты для запросов
  RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
</IfModule>

# ===================================
# ЗАЩИТА КОНФИГУРАЦИОННЫХ ФАЙЛОВ
# ===================================
<FilesMatch "^\.">
  Require all denied
</FilesMatch>

<FilesMatch "(package\.json|ecosystem\.config\.cjs|\.env)$">
  Require all denied
</FilesMatch>

